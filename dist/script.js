import{io as e}from'https://fastly.jsdelivr.net/npm/socket.io-client/+esm';var o={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return o.d(n,{a:n}),n},d:(e,n)=>{for(var t in n)o.o(n,t)&&!o.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:n[t]})},o:(e,o)=>Object.prototype.hasOwnProperty.call(e,o)};const n={url:'http://localhost:6620',delay:1e3},t={type:'script',script_id:getScriptId()};let r;function s(){return r||(insertVariables(n,t),r=_.defaults(n,getVariables(t))),r}let c=null;function a(){if(!c){const o=s();c=e(o.url,{retries:3}),c.on('connect',()=>{console.info('[TavernSync] 成功连接至服务器')}),c.on('connect_error',e=>{c.active?console.warn(`[TavernSync] 连接服务器出错, 尝试重连! ${e.stack}`):console.error(`[TavernSync] 连接服务器出错, 请手动连接重试! ${e.stack}`)}),c.on('disconnect',(e,o)=>{console.info(`[TavernSync] 与服务器断开连接: ${e}\n${JSON.stringify(o)}`)})}return c}const l=_.debounce(async function(e,o){getLorebooks().includes(e)||await createLorebook(e),await replaceLorebookEntries(e,o)},s().delay);const i=_;const p=o.n(i)().debounce(async function(e,o){await createOrReplacePreset(e,o),getLoadedPresetName()===e&&(console.info(getLoadedPresetName(),e),loadPreset(e))},s().delay);$(()=>{!function(){const e=a();e.on('pull_lorebook',async(e,o)=>{console.info(`[TavernSync] 收到提取世界书 '${e.lorebook}' 的请求`),o(await getLorebookEntries(e.lorebook)??void 0)}),e.on('push_lorebook',(e,o)=>{console.info(`[TavernSync] 收到推送世界书 '${e.lorebook}' 的请求`),l(e.lorebook,e.entries),o()})}(),function(){const e=a();e.on('pull_preset',(e,o)=>{console.info(`[TavernSync] 收到提取预设 '${e.preset_name}' 的请求`),o(getPreset(getLoadedPresetName()===e.preset_name?'in_use':e.preset_name)??void 0)}),e.on('push_preset',(e,o)=>{console.info(`[TavernSync] 收到推送预设 '${e.preset_name}' 的请求`),p(e.preset_name,e.preset),o()})}()});