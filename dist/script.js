import{io as e}from'https://testingcf.jsdelivr.net/npm/socket.io-client/+esm';import{compare as n}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';const o=z.object({url:z.string().default('http://localhost:6620'),delay:z.number().min(0).default(100)}),t={type:'script',script_id:getScriptId()};let r;function c(){return r||(r=o.parse(getVariables(t)),insertVariables(r,t)),r}let s=null;function a(){if(!s){const n=c();s=e(n.url,{transports:['websocket']}),s.on('connect',()=>{console.info('[TavernSync] 成功连接至服务器')}),s.on('connect_error',e=>{console.error(`[TavernSync] 连接服务器出错, 尝试重连! ${e.stack}`)}),s.on('disconnect',(e,n)=>{console.info(`[TavernSync] 与服务器断开连接: ${e}\n${JSON.stringify(n)}`)})}return s}const i=_.debounce(async function(e,n){await createOrReplacePreset(e,n),getLoadedPresetName()===e&&(console.info(getLoadedPresetName(),e),loadPreset(e))},c().delay);const l=_.debounce(async function(e,n){await createOrReplaceWorldbook(e,n)},c().delay);$(async()=>{const e=await getTavernHelperVersion();if(n(e,'3.4.0','<'))throw Error('酒馆助手版本过低, 不能使用酒馆同步脚本, 请更新至 3.4.0 或更高版本');!function(){const e=a();e.on('pull_worldbook',async(e,n)=>{console.info(`[TavernSync] 收到提取世界书 '${e.name}' 的请求`);try{n(await getWorldbook(e.name))}catch(o){const t=o;console.error(`[TavernSync] 提取世界书 '${e.name}' 失败: ${t}`),n(t.message)}}),e.on('push_worldbook',(e,n)=>{console.info(`[TavernSync] 收到推送世界书 '${e.name}' 的请求`),l(e.name,e.data.entries),n()})}(),function(){const e=a();e.on('pull_preset',(e,n)=>{console.info(`[TavernSync] 收到提取预设 '${e.name}' 的请求`);try{const o=getPreset(getLoadedPresetName()===e.name?'in_use':e.name);console.info(o),n(o)}catch(o){const t=o;console.error(`[TavernSync] 提取预设 '${e.name}' 失败: ${t}`),n(t.message)}}),e.on('push_preset',(e,n)=>{console.info(`[TavernSync] 收到推送预设 '${e.name}' 的请求`),i(e.name,e.data),n()})}()});