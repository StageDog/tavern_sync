import{io as e}from'https://testingcf.jsdelivr.net/npm/socket.io-client/+esm';import{compare as n}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';const o=z.object({url:z.string().default('http://localhost:6620'),delay:z.number().min(0).default(100),should_notify:z.boolean().default(!0),notify_for_breaking_change:z.boolean().default(!0)}),t={type:'script',script_id:getScriptId()};let a;function s(){return a||(a=o.parse(getVariables(t)),insertVariables(a,t)),a}let r=null;function i(){if(!r){const n=s();r=e(n.url,{transports:['websocket']}),r.on('connect',()=>{console.info('[TavernSync] 成功连接至服务器')}),r.on('connect_error',e=>{console.error(`[TavernSync] 连接服务器出错, 尝试重连! ${e.stack}`)}),r.on('disconnect',(e,n)=>{console.info(`[TavernSync] 与服务器断开连接: ${e}\n${JSON.stringify(n)}`)})}return r}const c=_.debounce(async function(e,n){await createOrReplacePreset(e,n),getLoadedPresetName()===e&&loadPreset(e),console.info(`[TavernSync] 已推送预设 '${e}' 到酒馆`),s().should_notify&&toastr.success(`已推送预设 '${e}' 到酒馆`,'TavernSync')},s().delay);const l=_.debounce(async function(e,n){await createOrReplaceWorldbook(e,n),console.info(`[TavernSync] 已推送世界书 '${e}' 到酒馆`),s().should_notify&&toastr.success(`已推送世界书 '${e}' 到酒馆`,'TavernSync')},s().delay);$(async()=>{const e=await getTavernHelperVersion();if(n(e,'3.4.11','<')&&toastr.error('酒馆助手版本过低, 不能使用酒馆同步脚本, 请更新至 3.4.11 或更高版本'),s().notify_for_breaking_change){await SillyTavern.callGenericPopup('<h2>更新提示</h2>同步脚本最近发生了不可通过 <code>node tavern_sync update</code> 更新的变动, 如果你还在用 tavern_sync.js, 请通过<a href="https://gitgud.io/StageDog/tavern_sync/-/raw/main/dist/tavern_sync.mjs?inline=false" target="_blank">下载链接</a>下载 tavern_sync.mjs',SillyTavern.POPUP_TYPE.CONFIRM,'',{okButton:'帮我下载',cancelButton:'我知道了'})===SillyTavern.POPUP_RESULT.AFFIRMATIVE&&window.open('https://gitgud.io/StageDog/tavern_sync/-/raw/main/dist/tavern_sync.mjs?inline=false','_blank'),insertOrAssignVariables({notify_for_breaking_change:!1},{type:'script',script_id:getScriptId()})}!function(){const e=i();e.on('export_worldbook',async(e,n)=>{console.info(`[TavernSync] 收到导出世界书 '${e.name}' 的请求`),await l.flush();const o=await SillyTavern.loadWorldInfo(e.name);if(!o)return s().should_notify&&toastr.error(`世界书 '${e.name}' 不存在`,'TavernSync'),void n(`世界书 '${e.name}' 不存在`);n(_.pick(o,['entries']))}),e.on('pull_worldbook',async(e,n)=>{console.info(`[TavernSync] 收到提取世界书 '${e.name}' 的请求`);try{const o=await getWorldbook(e.name);o.forEach(e=>{e.strategy.keys=e.strategy.keys.map(_.toString),e.strategy.keys_secondary.keys=e.strategy.keys_secondary.keys.map(_.toString)}),console.info(`[TavernSync] 已提取世界书 '${e.name}' 到本地`),s().should_notify&&toastr.success(`已提取世界书 '${e.name}' 到本地`,'TavernSync'),n(o)}catch(o){const t=o;console.error(`[TavernSync] 提取世界书 '${e.name}' 失败: ${t}`),s().should_notify&&toastr.success(`提取世界书 '${e.name}' 失败: ${t}`,'TavernSync'),n(t.message)}}),e.on('push_worldbook',(e,n)=>{console.info(`[TavernSync] 收到推送世界书 '${e.name}' 的请求`),l(e.name,e.data.entries),n()})}(),function(){const e=i();e.on('export_preset',async(e,n)=>{console.info(`[TavernSync] 收到导出预设 '${e.name}' 的请求`),await c.flush();const o=SillyTavern.getPresetManager('openai').getCompletionPresetByName(e.name);if(void 0===o)return s().should_notify&&toastr.error(`预设 '${e.name}' 不存在`,'TavernSync'),void n(`预设 '${e.name}' 不存在`);n(_.pick(o,['max_context_unlocked','openai_max_context','openai_max_tokens','n','stream_openai','temp_openai','freq_pen_openai','pres_pen_openai','top_p_openai','repetition_penalty_openai','min_p_openai','top_k_openai','top_a_openai','temperature','frequency_penalty','presence_penalty','top_p','repetition_penalty','min_p','top_k','top_a','seed','squash_system_messages','reasoning_effort','show_thoughts','request_images','function_calling','enable_web_search','image_inlining','inline_image_quality','video_inlining','names_behavior','wrap_in_quotes','prompts','prompt_order','extensions']))}),e.on('pull_preset',(e,n)=>{console.info(`[TavernSync] 收到提取预设 '${e.name}' 的请求`);try{n(getPreset(getLoadedPresetName()===e.name?'in_use':e.name)),console.info(`[TavernSync] 已提取预设 '${e.name}' 到本地`),s().should_notify&&toastr.success(`已提取预设 '${e.name}' 到本地`,'TavernSync')}catch(o){const t=o;console.error(`[TavernSync] 提取预设 '${e.name}' 失败: ${t}`),s().should_notify&&toastr.success(`提取预设 '${e.name}' 失败: ${t}`,'TavernSync'),n(t.message)}}),e.on('push_preset',(e,n)=>{console.info(`[TavernSync] 收到推送预设 '${e.name}' 的请求`),c(e.name,e.data),n()})}()});