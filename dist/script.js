import{io as e}from'https://testingcf.jsdelivr.net/npm/socket.io-client/+esm';import{compare as n}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';const o=z.object({url:z.string().default('http://localhost:6620'),delay:z.number().min(0).default(100),should_notify:z.boolean().default(!0),notify_for_character:z.boolean().default(!1)}),t={type:'script',script_id:getScriptId()};let a;function r(){return a||(a=o.parse(getVariables(t)),insertVariables(a,t)),a}let s=null;function c(){if(!s){const n=r();s=e(n.url,{transports:['websocket']}),s.on('connect',()=>{console.info('[TavernSync] 成功连接至服务器')}),s.on('connect_error',e=>{console.error(`[TavernSync] 连接服务器出错, 尝试重连! ${e.stack}`)}),s.on('disconnect',(e,n)=>{console.info(`[TavernSync] 与服务器断开连接: ${e}\n${JSON.stringify(n)}`)})}return s}function i(){const e=c();e.on('pull_character',async(e,n)=>{console.info(`[TavernSync] 收到提取角色卡 '${e.name}' 的请求`);try{const o=await getCharacter(e.name);_.set(o,'avatar',await fetch(getCharAvatarPath(e.name)).then(e=>e.blob())),_.set(o,'worldbook',o.worldbook??e.name),_.set(o,'entries',null!==o.worldbook&&getWorldbookNames().includes(o.worldbook)?await getWorldbook(o.worldbook):[]),_.has(o,'extensions.tavern_helper')&&_.update(o,'extensions.tavern_helper',e=>Array.isArray(e)?Object.fromEntries(e):e),console.info(`[TavernSync] 已提取角色卡 '${e.name}' 到本地`),r().should_notify&&toastr.success(`已提取角色卡 '${e.name}' 到本地`,'TavernSync'),n(o)}catch(o){const t=o;throw console.error(`[TavernSync] 提取角色卡 '${e.name}' 失败: ${t}`),r().should_notify&&toastr.error(`提取角色卡 '${e.name}' 失败: ${t}`,'TavernSync'),n(t.message),t}}),e.on('push_character',(e,n)=>{console.info(`[TavernSync] 收到推送角色卡 '${e.name}' 的请求`),async function(e,n){let o=RawCharacter.find({name:e})?getCharWorldbookNames(e).primary:null;0===n.entries.length&&null===o||(o??=n.worldbook,await replaceWorldbook(o,n.entries),_.set(n,'worldbook',o)),_.set(n,'first_messages',n.first_messages.map(({content:e})=>e)),_.set(n,'avatar',new Blob([new Uint8Array(n.avatar)],{type:'application/octet-stream'})),_.unset(n,'anchors'),_.unset(n,'entries'),getCharacterNames().includes(e)?await updateCharacterWith(e,e=>_.isNil(n.extensions)?{...n,extensions:e.extensions}:n):await createCharacter(e,n),console.info(`[TavernSync] 已推送角色卡 '${e}' 到酒馆`),r().should_notify&&toastr.success(`已推送角色卡 '${e}' 到酒馆`,'TavernSync')}(e.name,e.data),n()})}function l(){const e=c();e.on('pull_preset',(e,n)=>{console.info(`[TavernSync] 收到提取预设 '${e.name}' 的请求`);try{n(getPreset(getLoadedPresetName()===e.name?'in_use':e.name)),console.info(`[TavernSync] 已提取预设 '${e.name}' 到本地`),r().should_notify&&!e.queit&&toastr.success(`已提取预设 '${e.name}' 到本地`,'TavernSync')}catch(o){const t=o;console.error(`[TavernSync] 提取预设 '${e.name}' 失败: ${t}`),r().should_notify&&!e.queit&&toastr.error(`提取预设 '${e.name}' 失败: ${t}`,'TavernSync'),n(t.message)}}),e.on('push_preset',(e,n)=>{console.info(`[TavernSync] 收到推送预设 '${e.name}' 的请求`),async function(e,n){getPresetNames().includes(e)?await updatePresetWith(e,e=>_.isNil(n.extensions)?{...n,extensions:e.extensions}:n):await createPreset(e,n),getLoadedPresetName()===e&&loadPreset(e),console.info(`[TavernSync] 已推送预设 '${e}' 到酒馆`),r().should_notify&&toastr.success(`已推送预设 '${e}' 到酒馆`,'TavernSync')}(e.name,e.data),n()})}function y(){const e=c();e.on('pull_worldbook',async(e,n)=>{console.info(`[TavernSync] 收到提取世界书 '${e.name}' 的请求`);try{const o=await getWorldbook(e.name);o.forEach(e=>{e.strategy.keys=e.strategy.keys.map(_.toString),e.strategy.keys_secondary.keys=e.strategy.keys_secondary.keys.map(_.toString)}),console.info(`[TavernSync] 已提取世界书 '${e.name}' 到本地`),r().should_notify&&toastr.success(`已提取世界书 '${e.name}' 到本地`,'TavernSync'),n(o)}catch(o){const t=o;console.error(`[TavernSync] 提取世界书 '${e.name}' 失败: ${t}`),r().should_notify&&toastr.error(`提取世界书 '${e.name}' 失败: ${t}`,'TavernSync'),n(t.message)}}),e.on('push_worldbook',(e,n)=>{console.info(`[TavernSync] 收到推送世界书 '${e.name}' 的请求`),async function(e,n){await createOrReplaceWorldbook(e,n),console.info(`[TavernSync] 已推送世界书 '${e}' 到酒馆`),r().should_notify&&toastr.success(`已推送世界书 '${e}' 到酒馆`,'TavernSync')}(e.name,e.data.entries),n()})}$(async()=>{if(async function(e,o){n(await getTavernHelperVersion(),e,'<')&&toastr.error(`'${o}' 需要酒馆助手版本 >= '${e}'`,'版本不兼容')}('4.6.4','角色卡/世界书/预设同步脚本'),!r().notify_for_character){await SillyTavern.callGenericPopup('<h2>同步脚本支持同步角色卡了</h2>现在, 同步脚本也支持同步角色卡和打包角色卡! 用法与之前相同, 在 tavern_sync.yaml 文件里将<code>配置</code>填成<code>角色卡</code>, <code>酒馆中的名称</code>填成角色卡名称即可',SillyTavern.POPUP_TYPE.CONFIRM,'',{okButton:'查看具体说明',cancelButton:'我知道了'})===SillyTavern.POPUP_RESULT.AFFIRMATIVE&&window.open('https://stagedog.github.io/青空莉/工具经验/实时编写角色卡、世界书或预设/'),insertOrAssignVariables({notify_for_character:!0},{type:'script',script_id:getScriptId()})}i(),y(),l()});